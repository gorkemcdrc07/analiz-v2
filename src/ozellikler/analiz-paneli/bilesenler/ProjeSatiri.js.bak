// src/ozellikler/analiz-paneli/bilesenler/ProjeSatiri.jsx
import React, { useMemo, useState } from "react";
import { Box, Chip, Collapse, Divider, Stack, Typography, alpha } from "@mui/material";
import { useTheme } from "@mui/material/styles";
import {
    MdKeyboardArrowDown,
    MdKeyboardArrowUp,
    MdLocalShipping,
    MdPinDrop,
    MdHistory,
    MdOutlineTimer,
    MdAssignment,
    MdPerson,
    MdBolt,
    MdShoppingCart,
    MdCheckCircle,
    MdDoNotDisturbAlt,
    MdErrorOutline,
} from "react-icons/md";

import DurumRozeti from "./DurumRozeti";
import MiniIstatistik from "./MiniIstatistik";

import { altDetaylariOlustur } from "../../yardimcilar/veriKurallari";
import { metniNormalizeEt as norm, seferNoNormalizeEt } from "../../yardimcilar/metin";
import { tarihFormatla } from "../../yardimcilar/tarih";
import {
    ProjeKarti,
    KartBasligi,
    VurguCubugu,
    GenisletButonu,
    SevkiyatSarmal,
    SevkiyatKarti,
    SatirSekmeleri,
    SatirSekme,
    RotaKutusu,
} from "../../stiller/stilBilesenleri";

// Ã¢Å“â€¦ Tek tip pill/chip stili (alt detay chip'leri iÃƒÂ§in)
const pillSX = ({ theme, isDark, color, solid = false }) => ({
    height: 24,
    borderRadius: 999,
    fontWeight: 950,
    px: 1,
    letterSpacing: 0.2,
    bgcolor: solid ? (isDark ? alpha(color, 0.28) : color) : alpha(color, isDark ? 0.18 : 0.12),
    color: solid ? "#fff" : isDark ? theme.palette.text.primary : color,
    border: `1px solid ${alpha(color, isDark ? 0.32 : 0.22)}`,
    transition: "background-color .15s ease, transform .15s ease",
    "&:hover": {
        bgcolor: solid ? (isDark ? alpha(color, 0.34) : alpha(color, 0.92)) : alpha(color, isDark ? 0.22 : 0.16),
        transform: "translateY(-1px)",
    },
});

// Ã¢Å“â€¦ TR tarih (DD.MM.YYYY HH:mm) + ISO parse
const parseDT = (v) => {
    if (!v) return null;

    if (v instanceof Date) return Number.isNaN(v.getTime()) ? null : v;

    if (typeof v === "number") {
        const d = new Date(v);
        return Number.isNaN(d.getTime()) ? null : d;
    }

    const s = String(v).trim();
    if (!s) return null;

    // 13.01.2026 13:44  (saniye opsiyonel)
    const m = s.match(/^(\d{2})\.(\d{2})\.(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m) {
        const [, dd, MM, yyyy, hh = "00", mm = "00", ss = "00"] = m;
        const d = new Date(Number(yyyy), Number(MM) - 1, Number(dd), Number(hh), Number(mm), Number(ss));
        return Number.isNaN(d.getTime()) ? null : d;
    }

    // ISO vb
    const d = new Date(s);
    return Number.isNaN(d.getTime()) ? null : d;
};


// Ã¢Å“â€¦ iki tarih arasÃ„Â± fark (dakika)  =>  (to - from)
const dakikaFarki = (fromDate, toDate) => {
    const a = parseDT(fromDate);
    const b = parseDT(toDate);
    if (!a || !b) return null;
    if (Number.isNaN(a.getTime()) || Number.isNaN(b.getTime())) return null;
    return Math.floor((b.getTime() - a.getTime()) / (1000 * 60));
};

// Ã¢Å“â€¦ GEÃƒâ€¡ TEDARÃ„Â°K (SENÃ„Â°N KURALIN):
// (AÃƒÂ§Ã„Â±lÃ„Â±Ã…Å¸ - YÃƒÂ¼kleme) > 30 saat => geÃƒÂ§
const isGecTedarik = (despatchCreatedDate, pickupDate) => {
    const diffMin = dakikaFarki(pickupDate, despatchCreatedDate); // Ã¢Å“â€¦ pickup -> created  (created - pickup)
    if (diffMin == null) return false;

    // aÃƒÂ§Ã„Â±lÃ„Â±Ã…Å¸ yÃƒÂ¼klemeden ÃƒÂ¶nceyse (diff < 0) => geÃƒÂ§ deÃ„Å¸ildir
    if (diffMin < 0) return false;

    return diffMin > 30 * 60;
};

const dakikaGecikme = (despatchCreatedDate, pickupDate) => {
    const diffMin = dakikaFarki(pickupDate, despatchCreatedDate); // Ã¢Å“â€¦ created - pickup
    if (diffMin == null) return null;
    if (diffMin < 0) return 0;

    const lateMin = diffMin - 30 * 60;
    return lateMin > 0 ? lateMin : 0;
};

// (Ã„Â°stersen cutoffFromDespatch artÃ„Â±k gerekmediÃ„Å¸i iÃƒÂ§in silebilirsin)

// --- KPI ile aynÃ„Â± scope/iptal/SFR filtresi iÃƒÂ§in yardÃ„Â±mcÃ„Â±lar ---
const sayiCevir = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
};

const inScopeService = (serviceName) => {
    const s = norm(serviceName);
    return (
        s === norm("YURTİÇİ FTL HİZMETLERİ") ||
        s === norm("FİLO DIŞ YÜK YÖNETİMİ") ||
        s === norm("YURTİÇİ FRİGO HİZMETLERİ")
    );
};

// KPI ile aynÃ„Â± "geÃƒÂ§" kararÃ„Â±
const isGecTedarikKpiKurali = (it) => {
    // scope
    if (!inScopeService(it?.ServiceName)) return false;

    // SFR
    const despKey = String(seferNoNormalizeEt(it?.TMSDespatchDocumentNo) || "")
        .trim()
        .toUpperCase();

    if (!despKey.startsWith("SFR")) return false;

    // iptal hariÃƒÂ§
    const statu = sayiCevir(it?.OrderStatu);
    if (statu === 200) return false;

    // 30 saat
    return isGecTedarik(it?.TMSDespatchCreatedDate, it?.PickupDate);
};

// ÄŸÅ¸â€Â Neden geÃƒÂ§ sayÃ„Â±lmÃ„Â±yor? debug helper

const dakikaToSaatDakika = (mins) => {
    if (mins == null || !Number.isFinite(mins)) return null;
    const m = Math.max(0, Math.floor(mins));
    const h = Math.floor(m / 60);
    const r = m % 60;

    if (h <= 0) return `${r} dk`;
    if (r === 0) return `${h} saat`;
    return `${h} saat ${r} dk`;
};

/** Ã¢Å“â€¦ Modern Ã¢â‚¬Å“stat pillÃ¢â‚¬Â */
const StatPill = ({ icon, label, value, tone = "#0ea5e9" }) => {
    const theme = useTheme();
    const isDark = theme.palette.mode === "dark";

    const bg = isDark ? alpha(tone, 0.18) : alpha(tone, 0.12);
    const bd = isDark ? alpha(tone, 0.30) : alpha(tone, 0.22);
    const fg = isDark ? theme.palette.text.primary : tone;

    return (
        <Box
            sx={{
                display: "flex",
                alignItems: "center",
                gap: 1,
                px: 1.15,
                py: 0.75,
                borderRadius: 999,
                border: `1px solid ${bd}`,
                bgcolor: bg,
                backdropFilter: "blur(10px)",
                WebkitBackdropFilter: "blur(10px)",
                transition: "transform .15s ease, background-color .15s ease",
                "&:hover": {
                    transform: "translateY(-1px)",
                    bgcolor: isDark ? alpha(tone, 0.22) : alpha(tone, 0.15),
                },
            }}
        >
            <Box
                sx={{
                    width: 30,
                    height: 30,
                    borderRadius: 999,
                    display: "grid",
                    placeItems: "center",
                    bgcolor: isDark ? alpha("#fff", 0.06) : alpha("#0f172a", 0.06),
                    border: isDark ? `1px solid ${alpha("#fff", 0.10)}` : `1px solid ${alpha("#0f172a", 0.06)}`,
                }}
            >
                <Box sx={{ color: fg, display: "grid", placeItems: "center" }}>{icon}</Box>
            </Box>

            <Box sx={{ lineHeight: 1.05 }}>
                <Typography sx={{ fontSize: "0.66rem", fontWeight: 900, color: theme.palette.text.secondary, letterSpacing: "0.4px" }}>
                    {label}
                </Typography>
                <Typography sx={{ fontSize: "0.92rem", fontWeight: 1000, color: theme.palette.text.primary, letterSpacing: "-0.2px" }}>
                    {value}
                </Typography>
            </Box>
        </Box>
    );
};

export default function ProjeSatiri({
    satir,
    tumVeri,
    excelTarihleriSeferBazli = {},
    printsMap = {},
    printsLoading = false,
}) {
    const theme = useTheme();
    const isDark = theme.palette.mode === "dark";

    const [acik, setAcik] = useState(false);
    const [sekme, setSekme] = useState(0);

    const altDetaylar = useMemo(() => altDetaylariOlustur(satir.name, tumVeri), [satir.name, tumVeri]);

    // Ã¢Å“â€¦ Tek doÃ„Å¸ru kaynak: AnalizTablosu'nda hesaplanan proje bazlÃ„Â± geÃƒÂ§ tedarik
    const gecTedarikSayisi = Number(satir?.gec ?? 0);

    // Ã¢Å“â€¦ Tedarik edilmeyen (plan - ted)
    const tedarikEdilmeyen = useMemo(() => {
        const p = Number(satir?.plan ?? 0);
        const t = Number(satir?.ted ?? 0);
        const diff = p - t;
        return Number.isFinite(diff) ? Math.max(0, diff) : 0;
    }, [satir?.plan, satir?.ted]);

    // Ã¢Å“â€¦ ZamanÃ„Â±nda (%) = (Toplam Tedarik / Toplam Talep) * 100  (toplama gÃƒÂ¶re)
    const zamanindaYuzde = useMemo(() => {
        const plan = Number(satir?.plan ?? 0);
        const ted = Number(satir?.ted ?? 0);

        if (!Number.isFinite(plan) || plan <= 0) return 0;

        const oran = (Math.max(0, ted) / plan) * 100;
        return Math.max(0, Math.min(100, Math.round(oran)));
    }, [satir?.plan, satir?.ted]);

    // Ã¢Å“â€¦ Her zaman: gecikenler en ÃƒÂ¼stte, sonra gecikme dakikasÃ„Â± bÃƒÂ¼yÃƒÂ¼k olan ÃƒÂ¼stte
    const siraliAltDetaylar = useMemo(() => {
        const list = Array.isArray(altDetaylar) ? [...altDetaylar] : [];

        const lateList = [];
        const ontimeList = [];

        for (const it of list) {
            const late = isGecTedarikKpiKurali(it);
            const lateMin = late ? (dakikaGecikme(it?.TMSDespatchCreatedDate, it?.PickupDate) ?? 0) : 0;
            const createdTs = parseDT(it?.TMSDespatchCreatedDate)?.getTime() ?? 0;

            (late ? lateList : ontimeList).push({ it, lateMin, createdTs });
        }

        // geÃƒÂ§lerin kendi iÃƒÂ§inde: daha ÃƒÂ§ok geciken ÃƒÂ¼stte, sonra en yeni aÃƒÂ§Ã„Â±lÃ„Â±Ã…Å¸ ÃƒÂ¼stte
        lateList.sort((a, b) => (b.lateMin - a.lateMin) || (b.createdTs - a.createdTs));

        // zamanÃ„Â±ndalarÃ„Â±n kendi iÃƒÂ§inde: en yeni aÃƒÂ§Ã„Â±lÃ„Â±Ã…Å¸ ÃƒÂ¼stte
        ontimeList.sort((a, b) => b.createdTs - a.createdTs);

        return [...lateList, ...ontimeList].map((x) => x.it);
    }, [altDetaylar]);

    const vurguRengi = zamanindaYuzde >= 90 ? "#10b981" : zamanindaYuzde >= 70 ? "#3b82f6" : "#f59e0b";
    const gecTone = printsLoading ? "#64748b" : gecTedarikSayisi > 0 ? "#ef4444" : "#64748b";

    return (
        <ProjeKarti
            layout
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.22 }}
            whileHover={{ scale: 1.005 }}
        >
            <KartBasligi
                onClick={() => setAcik((s) => !s)}
                style={{ cursor: "pointer" }}
                sx={{
                    transition: "background-color .15s ease",
                    "&:hover": { bgcolor: isDark ? alpha("#fff", 0.03) : alpha("#0f172a", 0.03) },
                }}
            >
                <Stack direction="row" spacing={1.5} alignItems="center" sx={{ minWidth: 0 }}>
                    <VurguCubugu color={vurguRengi} />
                    <Box sx={{ minWidth: 0 }}>
                        <Typography
                            sx={{
                                fontWeight: 1000,
                                color: theme.palette.text.primary,
                                fontSize: { xs: "1.02rem", md: "1.08rem" },
                                letterSpacing: "-0.4px",
                                lineHeight: 1.15,
                                overflow: "hidden",
                                textOverflow: "ellipsis",
                                whiteSpace: "nowrap",
                                maxWidth: { xs: 220, md: 560 },
                            }}
                        >
                            {satir.name}
                        </Typography>

                        {/* Ã¢Å“â€¦ Modern ÃƒÂ¶zet alanÃ„Â± */}
                        <Stack
                            direction="row"
                            spacing={1}
                            alignItems="center"
                            sx={{
                                mt: 0.9,
                                flexWrap: "wrap",
                                rowGap: 0.9,
                                "& > *": { flexShrink: 0 },
                            }}
                        >
                            <StatPill icon={<MdShoppingCart size={18} />} label="Talep" value={satir.plan} tone="#0ea5e9" />
                            <StatPill icon={<MdCheckCircle size={18} />} label="Tedarik Edilen" value={satir.ted} tone="#10b981" />
                            <StatPill
                                icon={<MdDoNotDisturbAlt size={18} />}
                                label="Tedarik Edilmeyen"
                                value={tedarikEdilmeyen}
                                tone={tedarikEdilmeyen > 0 ? "#f59e0b" : "#64748b"}
                            />
                            <StatPill
                                icon={<MdErrorOutline size={18} />}
                                label="Geç Tedarik"
                                value={gecTedarikSayisi}
                                tone={gecTone}
                            />
                        </Stack>
                    </Box>
                </Stack>

                <Stack direction="row" spacing={2} alignItems="center">
                    <Stack direction="row" spacing={2} sx={{ display: { xs: "none", md: "flex" } }}>
                        <MiniIstatistik etiket="SPOT" deger={satir.spot} renk="#3b82f6" />
                        <MiniIstatistik etiket="FİLO" deger={satir.filo} renk="#8b5cf6" />
                        <MiniIstatistik etiket="SHÖ BASIM" deger={satir.sho_b} renk="#059669" />
                        <MiniIstatistik
                            etiket="Tedarik OranÃ„Â±"
                            deger={`%${zamanindaYuzde}`}
                            renk={zamanindaYuzde >= 90 ? "#10b981" : zamanindaYuzde >= 70 ? "#3b82f6" : "#f59e0b"}
                        />
                    </Stack>

                    <GenisletButonu open={acik ? 1 : 0}>{acik ? <MdKeyboardArrowUp size={22} /> : <MdKeyboardArrowDown size={22} />}</GenisletButonu>
                </Stack>
            </KartBasligi>

            <Collapse in={acik} timeout={250} unmountOnExit>
                <SevkiyatSarmal>
                    <SatirSekmeleri value={sekme} onChange={(e, v) => setSekme(v)} variant="scrollable" scrollButtons="auto">
                        <SatirSekme label="Genel BakÃ„Â±Ã…Å¸" />
                        <SatirSekme label="Zaman Ãƒâ€¡izelgesi" />
                        <SatirSekme label="Rota" />
                    </SatirSekmeleri>

                    <Box sx={{ mt: 1.5, display: "grid", gap: 12 }}>
                        {siraliAltDetaylar.map((item, idx) => {
                            const seferNo = item.TMSDespatchDocumentNo || "PlanlanmadÃ„Â±";
                            const key = seferNoNormalizeEt(seferNo);

                            const excelKaydi = excelTarihleriSeferBazli?.[key];

                            // SHÃƒâ€“ bilgisi gÃƒÂ¶sterimde kalsÃ„Â±n (geÃƒÂ§ tedarik hesabÃ„Â±na dahil deÃ„Å¸il)
                            const printedDate = key ? printsMap?.[key]?.PrintedDate : null;
                            const printedBy = key ? printsMap?.[key]?.PrintedBy : null;

                            // Ã¢Å“â€¦ Yeni zaman durumu: Sefer aÃƒÂ§Ã„Â±lÃ„Â±Ã…Å¸ Ã¢â€ â€™ YÃƒÂ¼kleme (30 saat)
                            const lateKpi = isGecTedarikKpiKurali(item);
                            const lateMinutes = lateKpi ? dakikaGecikme(item.TMSDespatchCreatedDate, item.PickupDate) : 0;

                            const zaman = {
                                label: lateKpi ? "GeÃƒÂ§ Tedarik" : "ZamanÃ„Â±nda",
                                color: lateKpi ? "#ef4444" : "#10b981",
                                lateMinutes,
                            };

                            const pickupCity = item.PickupCityName || "-";
                            const pickupCounty = item.PickupCountyName || "-";
                            const deliveryCity = item.DeliveryCityName || "-";
                            const deliveryCounty = item.DeliveryCountyName || "-";

                            const lateText =
                                zaman?.lateMinutes != null && zaman.lateMinutes > 0
                                    ? `${dakikaToSaatDakika(zaman.lateMinutes)} GeÃƒÂ§ Tedarik`
                                    : null;

                            return (
                                <SevkiyatKarti
                                    key={`${seferNoNormalizeEt(item.TMSDespatchDocumentNo) || item.TMSVehicleRequestDocumentNo || idx}`}
                                    printed={printedDate ? 1 : 0}
                                    initial={{ opacity: 0, y: 8 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    transition={{ duration: 0.18 }}
                                >
                                    <Stack direction="row" justifyContent="space-between" alignItems="flex-start" sx={{ mb: 1 }}>
                                        <Box sx={{ minWidth: 0 }}>
                                            <Typography
                                                sx={{
                                                    fontSize: "0.7rem",
                                                    fontWeight: 950,
                                                    color: theme.palette.text.secondary,
                                                    letterSpacing: "0.8px",
                                                }}
                                            >
                                                SEFER
                                            </Typography>

                                            <Typography sx={{ fontWeight: 1000, color: theme.palette.text.primary, fontSize: "1.05rem" }}>
                                                {seferNo}
                                            </Typography>

                                            <Stack direction="row" spacing={1} alignItems="center" sx={{ mt: 1, flexWrap: "wrap", rowGap: 0.9 }}>
                                                <DurumRozeti durumId={item.OrderStatu} />

                                                <Chip size="small" label={zaman.label} sx={pillSX({ theme, isDark, color: zaman.color, solid: true })} />

                                                {lateText && <Chip size="small" label={lateText} sx={pillSX({ theme, isDark, color: "#ef4444" })} />}

                                                {excelKaydi && <Chip size="small" label="Excel tarihleri var" sx={pillSX({ theme, isDark, color: "#0ea5e9" })} />}
                                            </Stack>
                                        </Box>

                                        <Chip
                                            size="small"
                                            label={`#${idx + 1}`}
                                            sx={{
                                                height: 26,
                                                borderRadius: 999,
                                                fontWeight: 1000,
                                                bgcolor: isDark ? alpha("#ffffff", 0.06) : alpha("#0f172a", 0.06),
                                                color: theme.palette.text.primary,
                                                border: isDark ? `1px solid ${alpha("#ffffff", 0.1)}` : "none",
                                            }}
                                        />
                                    </Stack>

                                    <Divider sx={{ my: 1.2, opacity: isDark ? 0.18 : 0.6 }} />

                                    {sekme === 0 && (
                                        <Stack direction={{ xs: "column", md: "row" }} spacing={2} alignItems="stretch">
                                            {/* OPERASYON */}
                                            <Box sx={{ flex: 1 }}>
                                                <Typography sx={{ fontSize: "0.7rem", fontWeight: 950, color: theme.palette.text.secondary, letterSpacing: "0.6px" }}>
                                                    OPERASYON
                                                </Typography>
                                                <Stack direction="row" spacing={1.2} alignItems="center" sx={{ mt: 1 }}>
                                                    <Box
                                                        sx={{
                                                            width: 36,
                                                            height: 36,
                                                            borderRadius: 999,
                                                            display: "grid",
                                                            placeItems: "center",
                                                            bgcolor: isDark ? alpha("#ffffff", 0.06) : "rgba(15,23,42,0.06)",
                                                            border: isDark ? `1px solid ${alpha("#ffffff", 0.1)}` : "none",
                                                        }}
                                                    >
                                                        <MdPerson size={18} color={isDark ? "#94a3b8" : "#64748b"} />
                                                    </Box>
                                                    <Typography sx={{ fontWeight: 1000, color: theme.palette.text.primary }}>{item.OrderCreatedBy || "-"}</Typography>
                                                </Stack>
                                            </Box>

                                            {/* GEÃƒâ€¡ TEDARÃ„Â°K HESABI */}
                                            <Box sx={{ flex: 1 }}>
                                                <Typography sx={{ fontSize: "0.7rem", fontWeight: 950, color: theme.palette.text.secondary, letterSpacing: "0.6px" }}>
                                                    GEÃƒâ€¡ TEDARÃ„Â°K HESABI (30 saat)
                                                </Typography>

                                                <Stack sx={{ mt: 1 }} spacing={0.8}>
                                                    <Stack direction="row" spacing={1} alignItems="center">
                                                        <MdHistory color={isDark ? "#94a3b8" : "#64748b"} />
                                                        <Typography sx={{ fontWeight: 900, color: theme.palette.text.primary }}>
                                                            Sefer aÃƒÂ§Ã„Â±lÃ„Â±Ã…Å¸: {tarihFormatla(item.TMSDespatchCreatedDate)}
                                                        </Typography>
                                                    </Stack>

                                                    <Stack direction="row" spacing={1} alignItems="center">
                                                        <MdOutlineTimer color="#10b981" />
                                                        <Typography sx={{ fontWeight: 900, color: theme.palette.text.primary }}>
                                                            YÃƒÂ¼kleme: {tarihFormatla(item.PickupDate)}
                                                        </Typography>
                                                    </Stack>

                                                    {/* SHÃƒâ€“ bilgisi opsiyonel */}
                                                    <Stack direction="row" spacing={1} alignItems="center">
                                                        <MdAssignment color={isDark ? "#94a3b8" : "#64748b"} />
                                                        <Typography sx={{ fontWeight: 900, color: theme.palette.text.primary }}>
                                                            SHÃƒâ€“ BasÃ„Â±m Tarihi: {printsLoading ? "..." : tarihFormatla(printedDate)}
                                                        </Typography>
                                                    </Stack>

                                                    <Stack direction="row" spacing={1} alignItems="center">
                                                        <MdPerson color={isDark ? "#94a3b8" : "#64748b"} />
                                                        <Typography sx={{ fontWeight: 900, color: theme.palette.text.primary }}>
                                                            SHÃƒâ€“ Basan KullanÃ„Â±cÃ„Â±: {printsLoading ? "..." : printedBy || "-"}
                                                        </Typography>
                                                    </Stack>
                                                </Stack>
                                            </Box>

                                            {/* ZAMAN BÃ„Â°LGÃ„Â°LERÃ„Â° */}
                                            <Box sx={{ flex: 1 }}>
                                                <Typography sx={{ fontSize: "0.7rem", fontWeight: 950, color: theme.palette.text.secondary, letterSpacing: "0.6px" }}>
                                                    ZAMAN BÃ„Â°LGÃ„Â°LERÃ„Â°
                                                </Typography>

                                                <Stack sx={{ mt: 1 }} spacing={0.8}>
                                                    <Stack direction="row" spacing={1} alignItems="center">
                                                        <MdHistory color={isDark ? "#94a3b8" : "#64748b"} />
                                                        <Typography sx={{ fontWeight: 900, color: theme.palette.text.primary }}>
                                                            Sefer aÃƒÂ§Ã„Â±lÃ„Â±Ã…Å¸: {tarihFormatla(item.TMSDespatchCreatedDate)}
                                                        </Typography>
                                                    </Stack>

                                                    <Stack direction="row" spacing={1} alignItems="center">
                                                        <MdAssignment color={isDark ? "#94a3b8" : "#64748b"} />
                                                        <Typography sx={{ fontWeight: 900, color: theme.palette.text.primary }}>
                                                            SipariÃ…Å¸: {tarihFormatla(item.OrderCreatedDate)}
                                                        </Typography>
                                                    </Stack>
                                                </Stack>
                                            </Box>

                                            {/* ROTA Ãƒâ€“ZETÃ„Â° */}
                                            <Box sx={{ flex: 1 }}>
                                                <Typography sx={{ fontSize: "0.7rem", fontWeight: 950, color: theme.palette.text.secondary, letterSpacing: "0.6px" }}>
                                                    ROTA Ãƒâ€“ZETÃ„°
                                                </Typography>

                                                <Stack direction="row" spacing={1.2} alignItems="center" sx={{ mt: 1 }}>
                                                    <MdPinDrop color="#10b981" />
                                                    <Typography sx={{ fontWeight: 1000, color: theme.palette.text.primary }}>
                                                        {pickupCity} / {pickupCounty}
                                                    </Typography>
                                                </Stack>

                                                <Stack direction="row" spacing={1.2} alignItems="center" sx={{ mt: 0.6 }}>
                                                    <MdLocalShipping color="#3b82f6" />
                                                    <Typography sx={{ fontWeight: 1000, color: theme.palette.text.primary }}>
                                                        {deliveryCity} / {deliveryCounty}
                                                    </Typography>
                                                </Stack>
                                            </Box>
                                        </Stack>
                                    )}

                                    {sekme === 1 && (
                                        <Box>
                                            <Typography sx={{ fontSize: "0.72rem", fontWeight: 950, color: theme.palette.text.secondary, letterSpacing: "0.6px" }}>
                                                SEFER AÃƒâ€¡ILIÃ…Â Ã¢â€ â€™ YÃƒÅ“KLEME (30 saat)
                                            </Typography>

                                            <Stack direction="row" spacing={1.2} alignItems="center" sx={{ mt: 1.2, flexWrap: "wrap" }}>
                                                <Chip
                                                    icon={<MdHistory />}
                                                    label={tarihFormatla(item.TMSDespatchCreatedDate)}
                                                    size="small"
                                                    sx={{
                                                        borderRadius: 999,
                                                        fontWeight: 950,
                                                        bgcolor: isDark ? alpha("#ffffff", 0.06) : alpha("#0f172a", 0.06),
                                                        color: theme.palette.text.primary,
                                                        border: isDark ? `1px solid ${alpha("#ffffff", 0.1)}` : "none",
                                                    }}
                                                />

                                                <Chip icon={<MdBolt />} label={lateText ? lateText : zaman.label} size="small" sx={pillSX({ theme, isDark, color: zaman.color })} />

                                                <Chip icon={<MdOutlineTimer />} label={tarihFormatla(item.PickupDate)} size="small" sx={pillSX({ theme, isDark, color: "#3b82f6" })} />
                                            </Stack>
                                        </Box>
                                    )}

                                    {sekme === 2 && (
                                        <Stack direction={{ xs: "column", md: "row" }} spacing={2} alignItems="stretch">
                                            <RotaKutusu t="pickup">
                                                <Stack direction="row" spacing={1} alignItems="center">
                                                    <MdPinDrop color="#10b981" />
                                                    <Typography sx={{ fontWeight: 1000, color: theme.palette.text.primary }}>YÃƒÂ¼kleme NoktasÃ„Â±</Typography>
                                                </Stack>

                                                <Typography sx={{ mt: 0.8, fontWeight: 1000, color: theme.palette.text.primary }}>{pickupCity}</Typography>
                                                <Typography sx={{ fontWeight: 900, color: theme.palette.text.secondary }}>{pickupCounty}</Typography>
                                            </RotaKutusu>

                                            <Box sx={{ display: "grid", placeItems: "center", px: 1 }}>
                                                <MdLocalShipping size={28} color="#3b82f6" />
                                            </Box>

                                            <RotaKutusu t="delivery">
                                                <Stack direction="row" spacing={1} alignItems="center" justifyContent="flex-end">
                                                    <Typography sx={{ fontWeight: 1000, color: theme.palette.text.primary }}>Teslimat NoktasÃ„Â±</Typography>
                                                    <MdPinDrop color="#ef4444" />
                                                </Stack>

                                                <Typography sx={{ mt: 0.8, fontWeight: 1000, color: theme.palette.text.primary, textAlign: "right" }}>
                                                    {deliveryCity}
                                                </Typography>

                                                <Typography sx={{ fontWeight: 900, color: theme.palette.text.secondary, textAlign: "right" }}>
                                                    {deliveryCounty}
                                                </Typography>
                                            </RotaKutusu>
                                        </Stack>
                                    )}
                                </SevkiyatKarti>
                            );
                        })}
                    </Box>
                </SevkiyatSarmal>
            </Collapse>
        </ProjeKarti>
    );
}
